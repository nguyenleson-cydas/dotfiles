#!/bin/bash

# Configuration - multiple search directories
SEARCH_DIRS=(
  "$HOME/dev/intern"
  "$HOME/dev/personal"
  "$HOME/work/projects"
  "$HOME/learning"
  "$HOME/notes"
  "$HOME/.config"
)

FZF_PROMPT="Select a directory: "
FZF_LAYOUT="reverse"

# Find directories from all search paths
directories=()
for dir in "${SEARCH_DIRS[@]}"; do
  if [[ -d "$dir" ]]; then
    # List all items in directory and check if they're directories (including symlinks)
    for item in "$dir"/* "$dir"/.*; do
      # Skip . and ..
      [[ "$item" == "$dir/." || "$item" == "$dir/.." ]] && continue
      # Check if it's a directory (this will be true for both real dirs and symlinks to dirs)
      if [[ -d "$item" ]]; then
        directories+=("$item")
      fi
    done
  fi
done

# Exit if no directories found
if [[ ${#directories[@]} -eq 0 ]]; then
  echo "No directories found in search paths" >&2
  exit 1
fi

# Select directory with fzf
selected=$(printf '%s\n' "${directories[@]}" | fzf --prompt="$FZF_PROMPT" --layout="$FZF_LAYOUT")

# Exit if no directory was selected
if [[ -z "$selected" ]]; then
  exit 0
fi

# Create session name from directory name
session_name=$(basename "$selected")

# Clean up session name for tmux (no spaces, special characters)
session_name=$(echo "$session_name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9_-]/-/g' | sed 's/-\+/-/g')

if [[ -z "$TMUX" ]]; then
  # Outside tmux
  tmux new-session -A -s "$session_name" -c "$selected"
else
  # Inside tmux
  if tmux has-session -t "$session_name" 2>/dev/null; then
    tmux switch-client -t "$session_name"
  else
    tmux new-session -d -s "$session_name" -c "$selected"
    tmux switch-client -t "$session_name"
  fi
fi
